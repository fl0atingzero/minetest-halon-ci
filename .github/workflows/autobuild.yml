name: autobuild-all

on:
  workflow_dispatch:
    inputs:
      reason:
        description: Why run all?
        required: false
        type: string
  schedule:
    - cron: "0 0 */2 * *"

permissions:
  contents: write
  actions:  read

concurrency:
  group: nightly
  cancel-in-progress: false

jobs:
  android:
    uses: ./.github/workflows/android.yml
    secrets: inherit

  macos:
    uses: ./.github/workflows/macos.yml

  windows:
    uses: ./.github/workflows/windows.yml

  collect-and-release:
    needs: [android, macos, windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write   # управлять релизами/тегами
      actions: read     # качать артефакты по run-id
    env:
      GH_TOKEN: ${{ github.token }}   # для gh CLI
    steps:
      - uses: actions/checkout@v4

      - name: Prepare dist
        run: mkdir -p dist

      - name: Download artifacts (android)
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ needs.android.outputs.run_id }}
          path: dist

      - name: Download artifacts (macOS)
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ needs.macos.outputs.run_id }}
          path: dist

      - name: Download artifacts (Windows)
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ needs.windows.outputs.run_id }}
          path: dist

      - name: Flatten artifacts to their artifact names; zip when needed
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          out="dist_out"
          mkdir -p "$out"

          for d in dist/*/ ; do
            base="${d%/}"; base="${base##*/}"   # artifact name (folder name)
            files=( "$d"* )
            if (( ${#files[@]} != 1 )); then
              echo "ERROR: expected exactly 1 file in artifact '$base', got ${#files[@]}"
              ls -la "$d"
              exit 1
            fi

            f="${files[0]}"
            ext="${f##*.}"; ext="${ext,,}"      # file extension (lowercased)

            case "$ext" in
              zip)
                # Windows: already zipped -> rename to <artifact>.zip
                mv -- "$f" "$out/${base}.zip"
                ;;

              dmg)
                # macOS: zip the DMG -> <artifact>.dmg.zip
                zip -9 -q -j "$out/${base}.dmg.zip" "$f"
                ;;

              aab|apks)
                # Android: want <artifact>.zip; artifact name already ends with .aab/.apks
                if [[ "$base" =~ \.(aab|apks)$ ]]; then
                  zip -9 -q -j "$out/${base}.zip" "$f"
                else
                  # fallback if artifact name didn't include the ext
                  zip -9 -q -j "$out/${base}.${ext}.zip" "$f"
                fi
                ;;

              *)
                # Fallback: keep extension
                mv -- "$f" "$out/${base}.${ext}"
                ;;
            esac

            rm -rf -- "$d"
            echo "-> $out/$(basename -- "$out/${base}")"
          done

          rm -rf dist
          mv "$out" dist

      - name: List collected files
        run: |
          echo "Collected files:"
          find dist -maxdepth 1 -type f -printf '%f\n' | sort

      # Полное пересоздание релиза, чтобы обновлялась Published дата
      - name: Re-create 'nightly' release fresh (delete then create)
        run: |
          set -euo pipefail
          tag="nightly"
          title="Nightly build $(date -u +'%Y-%m-%d %H:%M UTC')"

          if gh release view "$tag" >/dev/null 2>&1; then
            echo "Deleting existing release '$tag' (and tag)..."
            gh release delete "$tag" --cleanup-tag -y
          fi

          echo "Creating release '$tag'..."
          gh release create "$tag" \
            --title "$title" \
            --notes "Automated nightly build" \
            --latest \
            --target "$GITHUB_SHA"

      - name: Generate release notes
        run: |
          {
            echo "Artifacts:"
            find dist -maxdepth 1 -type f -printf ' - %f\n' | sort
          } > notes.md
          cat notes.md

      - name: Upload fresh assets (use artifact names)
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(dist/*)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No artifacts found in dist/"; exit 1
          fi
          gh release upload nightly "${files[@]}" --clobber
          gh release edit nightly --notes-file notes.md

