name: autobuild-all

on:
  workflow_dispatch:
    inputs:
      reason:
        description: Why run all?
        required: false
        type: string
  schedule:
    - cron: "0 0 */2 * *"

permissions:
  contents: write
  actions:  read

concurrency:
  group: nightly
  cancel-in-progress: false

jobs:
  android:
    uses: ./.github/workflows/android.yml
    secrets: inherit

  macos:
    uses: ./.github/workflows/macos.yml

  windows:
    uses: ./.github/workflows/windows.yml

  collect-and-release:
    needs: [android, macos, windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write   # управлять релизами/тегами
      actions: read     # качать артефакты по run-id
    env:
      GH_TOKEN: ${{ github.token }}   # для gh CLI
    steps:
      - uses: actions/checkout@v4

      - name: Prepare dist
        run: mkdir -p dist

      - name: Download artifacts (android)
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ needs.android.outputs.run_id }}
          path: dist

      - name: Download artifacts (macOS)
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ needs.macos.outputs.run_id }}
          path: dist

      - name: Download artifacts (Windows)
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ needs.windows.outputs.run_id }}
          path: dist

      - name: Flatten artifact directories and rename to artifact names
        run: |
          set -euo pipefail
          shopt -s nullglob
          count=0
          while IFS= read -r -d '' d; do
            base="$(basename "$d")"
            files=( "$d"/* )
            if (( ${#files[@]} == 0 )); then
              echo "WARN: no files in $d"
              continue
            fi
            if (( ${#files[@]} > 1 )); then
              echo "ERROR: more than one file in artifact $base"
              ls -la "$d"
              exit 1
            fi
            f="${files[0]}"
            # переименуем в dist/<artifact-name>
            mv "$f" "dist/$base"
            rmdir "$d"
            echo "-> dist/$base"
            ((count++))
          done < <(find dist -mindepth 1 -maxdepth 1 -type d -print0)
          echo "Flattened $count artifacts."

      - name: List collected files
        run: |
          echo "Collected files:"
          find dist -maxdepth 1 -type f -printf '%f\n' | sort

      # Полное пересоздание релиза, чтобы обновлялась Published дата
      - name: Re-create 'nightly' release fresh (delete then create)
        run: |
          set -euo pipefail
          tag="nightly"
          title="Nightly build $(date -u +'%Y-%m-%d %H:%M UTC')"

          if gh release view "$tag" >/dev/null 2>&1; then
            echo "Deleting existing release '$tag' (and tag)..."
            gh release delete "$tag" --cleanup-tag -y
          fi

          echo "Creating release '$tag'..."
          gh release create "$tag" \
            --title "$title" \
            --notes "Automated nightly build" \
            --latest \
            --target "$GITHUB_SHA"

      - name: Generate release notes
        run: |
          {
            echo "Artifacts:"
            find dist -maxdepth 1 -type f -printf ' - %f\n' | sort
          } > notes.md
          cat notes.md

      - name: Upload fresh assets (use artifact names)
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(dist/*)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No artifacts found in dist/"; exit 1
          fi
          gh release upload nightly "${files[@]}" --clobber
          gh release edit nightly --notes-file notes.md --latest
